<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bicycle Ride Tracker</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111c34;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --text: #e2e8f0;
      --muted: #94a3b8;
      --shadow: 0 18px 35px rgba(15, 23, 42, 0.45);
      --card-radius: 16px;
      --success: #34d399;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1e3a8a, #0b1120 50%, #020617);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 32px 16px 64px;
    }

    h1, h2, h3, h4 {
      margin: 0;
      font-weight: 600;
    }

    p {
      color: var(--muted);
      line-height: 1.6;
    }

    .muted {
      color: var(--muted);
    }

    button {
      font-family: inherit;
    }

    .app {
      width: min(1120px, 100%);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title {
      font-size: clamp(1.75rem, 2.5vw, 2.5rem);
      font-weight: 700;
    }

    .regimen-card {
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(18px);
      border-radius: var(--card-radius);
      padding: 20px;
      display: grid;
      gap: 16px;
      box-shadow: var(--shadow);
    }

    .regimen-form {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    input[type="date"],
    input[type="number"],
    input[type="text"],
    textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(2, 6, 23, 0.6);
      color: var(--text);
      font-size: 0.95rem;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    input:focus,
    textarea:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .primary-button {
      align-self: end;
      padding: 12px 18px;
      border-radius: 12px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 10px 20px rgba(56, 189, 248, 0.25);
    }

    .primary-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 28px rgba(56, 189, 248, 0.35);
    }

    .progress-section {
      background: rgba(15, 23, 42, 0.65);
      backdrop-filter: blur(18px);
      border-radius: var(--card-radius);
      padding: 24px;
      display: grid;
      gap: 20px;
      box-shadow: var(--shadow);
    }

    .progress-container {
      display: flex;
      gap: 8px;
    }

    .phase-segment {
      flex: 1;
      position: relative;
      padding: 16px 12px 42px;
      border-radius: 14px;
      background: rgba(148, 163, 184, 0.12);
      overflow: hidden;
      transition: transform 0.2s ease;
    }

    .phase-segment.current {
      box-shadow: 0 0 0 2px var(--accent);
      transform: translateY(-4px);
    }

    .phase-segment.completed {
      background: rgba(52, 211, 153, 0.2);
    }

    .phase-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.7), rgba(99, 102, 241, 0.8));
      transform-origin: left;
      width: 0%;
      transition: width 0.4s ease;
      mix-blend-mode: screen;
    }

    .phase-label {
      position: relative;
      display: grid;
      gap: 6px;
      font-size: 0.9rem;
    }

    .phase-label small {
      color: var(--muted);
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .phase-quotes {
      display: grid;
      gap: 12px;
    }

    .quote-card {
      border-radius: 12px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.45);
      border: 1px solid rgba(56, 189, 248, 0.18);
    }

    .quote-card.current {
      border-color: var(--accent);
      box-shadow: 0 12px 24px rgba(56, 189, 248, 0.18);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--card-radius);
      padding: 20px;
      display: grid;
      gap: 12px;
      box-shadow: var(--shadow);
    }

    .stat-card h3 {
      color: var(--accent);
      font-size: 1.1rem;
    }

    .stat-metric {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .view-toggle {
      display: inline-flex;
      background: rgba(15, 23, 42, 0.65);
      border-radius: 999px;
      padding: 4px;
      width: fit-content;
      box-shadow: var(--shadow);
    }

    .toggle-button {
      border: none;
      background: transparent;
      color: var(--muted);
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.03em;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .toggle-button.active {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(99, 102, 241, 0.2));
      color: var(--text);
    }

    .view {
      display: none;
    }

    .view.active {
      display: grid;
      gap: 20px;
    }

    .ride-form {
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--card-radius);
      padding: 20px;
      display: grid;
      gap: 16px;
      box-shadow: var(--shadow);
    }

    .ride-form-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    .ride-list {
      display: grid;
      gap: 12px;
    }

    .ride-entry {
      border-radius: 14px;
      padding: 16px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: grid;
      gap: 6px;
    }

    .ride-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .ride-entry-header h4 {
      font-size: 1.05rem;
    }

    .ride-entry-header span {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .ride-entry p {
      margin: 0;
      font-size: 0.92rem;
    }

    .ride-entry .notes {
      color: var(--text);
    }

    .calendar {
      background: rgba(15, 23, 42, 0.65);
      border-radius: var(--card-radius);
      padding: 20px;
      display: grid;
      gap: 20px;
      box-shadow: var(--shadow);
    }

    .calendar-months {
      display: grid;
      gap: 20px;
    }

    .calendar-month {
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .calendar-header h3 {
      font-size: 1rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .calendar-grid {
      display: grid;
      gap: 4px;
      grid-template-columns: repeat(7, minmax(0, 1fr));
    }

    .weekday {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      text-align: center;
      padding-bottom: 4px;
    }

    .day-cell {
      position: relative;
      padding: 10px 0;
      text-align: center;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: default;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .day-cell.other-month {
      opacity: 0.2;
    }

    .day-cell.has-ride {
      background: rgba(56, 189, 248, 0.18);
      border: 1px solid rgba(56, 189, 248, 0.4);
      cursor: pointer;
      font-weight: 600;
    }

    .day-cell.has-ride:hover {
      transform: translateY(-2px);
      background: rgba(56, 189, 248, 0.3);
    }

    .placeholder {
      text-align: center;
      color: var(--muted);
      padding: 24px 0;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(56, 189, 248, 0.3);
      max-width: 320px;
      transform: translateY(30px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 50;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .toast h4 {
      margin-bottom: 8px;
    }

    .toast ul {
      margin: 0;
      padding-left: 18px;
      display: grid;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    @media (max-width: 768px) {
      body {
        padding: 24px 12px 48px;
      }

      .phase-segment {
        padding-bottom: 56px;
      }

      .phase-label {
        font-size: 0.85rem;
      }

      .calendar-months {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <div class="title">Bicycle Ride Tracker</div>
        <p>Track your regimen, stay motivated, and watch the progress unfold ride by ride.</p>
      </div>
      <div class="regimen-card">
        <h2>Training Regimen</h2>
        <div class="regimen-form">
          <div>
            <label for="startDate">Start Date</label>
            <input type="date" id="startDate" />
          </div>
          <div>
            <label for="endDate">End Date</label>
            <input type="date" id="endDate" />
          </div>
          <button class="primary-button" id="applyRegimen">Set Plan</button>
        </div>
        <p id="regimenSummary" class="muted">Choose your training window to begin tracking rides.</p>
      </div>
    </header>

    <section class="progress-section">
      <div class="progress-container" id="progressContainer"></div>
      <div class="phase-quotes" id="phaseQuotes"></div>
    </section>

    <section class="stats-grid">
      <div class="stat-card">
        <h3>This Month</h3>
        <div class="stat-metric"><span>Total distance</span><strong id="thisMonthTotalDistance">0 km</strong></div>
        <div class="stat-metric"><span>Average distance</span><strong id="thisMonthAverageDistance">0 km</strong></div>
        <div class="stat-metric"><span>Average speed</span><strong id="thisMonthAverageSpeed">0 km/h</strong></div>
        <div class="stat-metric"><span>Longest ride</span><strong id="thisMonthLongestRide">0 km</strong></div>
      </div>
      <div class="stat-card">
        <h3>All-Time</h3>
        <div class="stat-metric"><span>Total distance</span><strong id="allTimeTotalDistance">0 km</strong></div>
        <div class="stat-metric"><span>Average distance</span><strong id="allTimeAverageDistance">0 km</strong></div>
        <div class="stat-metric"><span>Average speed</span><strong id="allTimeAverageSpeed">0 km/h</strong></div>
        <div class="stat-metric"><span>Longest ride</span><strong id="allTimeLongestRide">0 km</strong></div>
      </div>
    </section>

    <div class="view-toggle">
      <button class="toggle-button active" data-view="list" id="listToggle">List View</button>
      <button class="toggle-button" data-view="calendar" id="calendarToggle">Calendar View</button>
    </div>

    <section class="view active" id="listView">
      <div class="ride-form">
        <h2>Log a Ride</h2>
        <div class="ride-form-grid">
          <div>
            <label for="rideDate">Date</label>
            <input type="date" id="rideDate" />
          </div>
          <div>
            <label for="rideDistance">Distance (km)</label>
            <input type="number" id="rideDistance" min="0" step="0.1" placeholder="0.0" />
          </div>
          <div>
            <label for="rideDuration">Duration (hh:mm)</label>
            <input type="text" id="rideDuration" placeholder="02:15" />
          </div>
          <div>
            <label for="rideNotes">Notes</label>
            <textarea id="rideNotes" placeholder="Weather, route, how you felt..."></textarea>
          </div>
        </div>
        <button class="primary-button" id="logRide">Add Ride</button>
      </div>
      <div class="ride-list" id="rideList">
        <p class="placeholder">No rides logged yet. Your journey starts with the first pedal stroke.</p>
      </div>
    </section>

    <section class="view" id="calendarView">
      <div class="calendar">
        <h2>Training Calendar</h2>
        <div class="calendar-months" id="calendarMonths">
          <p class="placeholder">Set your training regimen to explore the calendar.</p>
        </div>
      </div>
    </section>
  </div>
  <div class="toast" id="toast"></div>

  <script>
    const phaseConfig = [
      {
        label: "Phase 1",
        title: "Foundation & Habit",
        months: 6,
        quote: "Lay the groundwork: consistency now paves the road to your strongest ride yet."
      },
      {
        label: "Phase 2",
        title: "Endurance Building",
        months: 6,
        quote: "Stretch the distance—each kilometer adds to a reservoir of resilience."
      },
      {
        label: "Phase 3",
        title: "Strength & Prep Season",
        months: 6,
        quote: "Power up the climbs, sharpen the turns, own every challenge ahead."
      },
      {
        label: "Phase 4",
        title: "Tour Simulation",
        months: 4,
        quote: "Ride like it's the real thing—visualize victory and make it muscle memory."
      },
      {
        label: "Phase 5",
        title: "Launch Window",
        months: 1,
        quote: "Trust the work, taper smart, and arrive at the start line ready to fly."
      }
    ];

    const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    const monthNames = [
      "January",
      "February",
      "March",
      "April",
      "May",
      "June",
      "July",
      "August",
      "September",
      "October",
      "November",
      "December"
    ];

    const regimenSummary = document.getElementById("regimenSummary");
    const progressContainer = document.getElementById("progressContainer");
    const phaseQuotes = document.getElementById("phaseQuotes");
    const listToggle = document.getElementById("listToggle");
    const calendarToggle = document.getElementById("calendarToggle");
    const listView = document.getElementById("listView");
    const calendarView = document.getElementById("calendarView");
    const rideList = document.getElementById("rideList");
    const calendarMonths = document.getElementById("calendarMonths");
    const toast = document.getElementById("toast");

    let regimenStart = null;
    let regimenEnd = null;
    let phases = [];
    const rides = [];
    let toastTimer = null;

    document.getElementById("applyRegimen").addEventListener("click", () => {
      const startValue = document.getElementById("startDate").value;
      const endValue = document.getElementById("endDate").value;

      if (!startValue || !endValue) {
        alert("Please choose both start and end dates for your regimen.");
        return;
      }

      const startDate = new Date(startValue + "T00:00:00");
      const endDate = new Date(endValue + "T23:59:59");

      if (isNaN(startDate) || isNaN(endDate) || startDate > endDate) {
        alert("Please ensure the dates are valid and the start is before the end.");
        return;
      }

      regimenStart = startDate;
      regimenEnd = endDate;

      regimenSummary.textContent = `Training from ${formatDate(regimenStart)} to ${formatDate(regimenEnd)}.`;

      const filteredRides = rides.filter((ride) => ride.date >= regimenStart && ride.date <= regimenEnd);
      if (filteredRides.length !== rides.length) {
        rides.length = 0;
        rides.push(...filteredRides);
      }

      phases = buildPhases(regimenStart);
      renderPhases();
      renderQuotes();
      renderCalendar();
      renderRideList();
      updateStats();
      enforceDateBounds();
    });

    document.getElementById("logRide").addEventListener("click", () => {
      if (!regimenStart || !regimenEnd) {
        alert("Please set your training regimen before logging rides.");
        return;
      }

      const dateValue = document.getElementById("rideDate").value;
      const distanceValue = parseFloat(document.getElementById("rideDistance").value);
      const durationValue = document.getElementById("rideDuration").value.trim();
      const notesValue = document.getElementById("rideNotes").value.trim();

      if (!dateValue || isNaN(distanceValue) || distanceValue <= 0 || !durationValue) {
        alert("Please provide a date, positive distance, and duration in hh:mm format.");
        return;
      }

      const rideDate = new Date(dateValue + "T00:00:00");
      if (rideDate < regimenStart || rideDate > regimenEnd) {
        alert("This ride falls outside of your current regimen.");
        return;
      }

      const durationMatch = durationValue.match(/^(\d{1,2}):(\d{2})$/);
      if (!durationMatch) {
        alert("Duration must be in hh:mm format.");
        return;
      }

      const hours = parseInt(durationMatch[1], 10);
      const minutes = parseInt(durationMatch[2], 10);

      if (minutes >= 60 || (hours === 0 && minutes === 0)) {
        alert("Please enter a duration longer than 00:00 with minutes less than 60.");
        return;
      }

      const totalMinutes = hours * 60 + minutes;

      rides.push({
        id: Date.now(),
        date: rideDate,
        distance: distanceValue,
        durationMinutes: totalMinutes,
        notes: notesValue
      });

      rides.sort((a, b) => b.date - a.date || b.id - a.id);

      document.getElementById("rideDate").value = "";
      document.getElementById("rideDistance").value = "";
      document.getElementById("rideDuration").value = "";
      document.getElementById("rideNotes").value = "";

      renderRideList();
      updateStats();
      renderCalendar();
    });

    listToggle.addEventListener("click", () => switchView("list"));
    calendarToggle.addEventListener("click", () => switchView("calendar"));

    function switchView(view) {
      if (view === "list") {
        listToggle.classList.add("active");
        calendarToggle.classList.remove("active");
        listView.classList.add("active");
        calendarView.classList.remove("active");
      } else {
        calendarToggle.classList.add("active");
        listToggle.classList.remove("active");
        calendarView.classList.add("active");
        listView.classList.remove("active");
        renderCalendar();
      }
    }

    function buildPhases(startDate) {
      const computedPhases = [];
      let phaseStart = new Date(startDate);

      for (const phase of phaseConfig) {
        const phaseEnd = addMonths(phaseStart, phase.months);
        phaseEnd.setDate(phaseEnd.getDate() - 1);

        computedPhases.push({
          ...phase,
          start: new Date(phaseStart),
          end: new Date(phaseEnd)
        });

        phaseStart = new Date(phaseEnd);
        phaseStart.setDate(phaseStart.getDate() + 1);
      }

      return computedPhases;
    }

    function renderPhases() {
      progressContainer.innerHTML = "";
      if (!phases.length) {
        const placeholder = document.createElement("p");
        placeholder.className = "placeholder";
        placeholder.textContent = "Set your regimen to activate the phase timeline.";
        progressContainer.appendChild(placeholder);
        return;
      }

      const today = startOfDay(new Date());

      phases.forEach((phase) => {
        const segment = document.createElement("div");
        segment.className = "phase-segment";

        const phaseDays = Math.max(1, diffInDays(phase.start, phase.end) + 1);
        segment.style.flex = phaseDays;

        const fill = document.createElement("div");
        fill.className = "phase-fill";
        const totalMs = Math.max(1, phase.end.getTime() - phase.start.getTime() + 86400000);
        const completion = clamp((today.getTime() - phase.start.getTime()) / totalMs);
        if (today > phase.end) {
          fill.style.width = "100%";
          segment.classList.add("completed");
        } else if (today < phase.start) {
          fill.style.width = "0%";
        } else {
          fill.style.width = `${(completion * 100).toFixed(2)}%`;
          segment.classList.add("current");
        }

        const label = document.createElement("div");
        label.className = "phase-label";
        label.innerHTML = `<strong>${phase.label}</strong><small>${formatDate(phase.start)} – ${formatDate(phase.end)}</small><span>${phase.title}</span>`;

        segment.appendChild(fill);
        segment.appendChild(label);
        progressContainer.appendChild(segment);
      });
    }

    function renderQuotes() {
      phaseQuotes.innerHTML = "";
      if (!phases.length) {
        return;
      }

      const today = startOfDay(new Date());

      phases.forEach((phase) => {
        const card = document.createElement("div");
        card.className = "quote-card";

        if (today >= phase.start && today <= phase.end) {
          card.classList.add("current");
        }

        card.innerHTML = `<h4>${phase.label}: ${phase.title}</h4><p>${phase.quote}</p>`;
        phaseQuotes.appendChild(card);
      });
    }

    function renderRideList() {
      rideList.innerHTML = "";

      if (!rides.length) {
        const placeholder = document.createElement("p");
        placeholder.className = "placeholder";
        placeholder.textContent = "No rides logged yet. Your journey starts with the first pedal stroke.";
        rideList.appendChild(placeholder);
        return;
      }

      rides.forEach((ride) => {
        const entry = document.createElement("article");
        entry.className = "ride-entry";

        const header = document.createElement("div");
        header.className = "ride-entry-header";

        const title = document.createElement("h4");
        title.textContent = formatDate(ride.date);

        const meta = document.createElement("span");
        meta.textContent = `${formatNumber(ride.distance)} km • ${formatDuration(ride.durationMinutes)}`;

        header.appendChild(title);
        header.appendChild(meta);

        const speed = document.createElement("p");
        speed.innerHTML = `<strong>Average speed:</strong> ${formatNumber(calculateSpeed(ride))} km/h`;

        entry.appendChild(header);
        entry.appendChild(speed);

        if (ride.notes) {
          const notes = document.createElement("p");
          notes.className = "notes";
          notes.innerHTML = `<strong>Notes:</strong> ${escapeHTML(ride.notes)}`;
          entry.appendChild(notes);
        }

        rideList.appendChild(entry);
      });
    }

    function renderCalendar() {
      calendarMonths.innerHTML = "";

      if (!regimenStart || !regimenEnd) {
        const placeholder = document.createElement("p");
        placeholder.className = "placeholder";
        placeholder.textContent = "Set your training regimen to explore the calendar.";
        calendarMonths.appendChild(placeholder);
        return;
      }

      const startMonth = new Date(regimenStart.getFullYear(), regimenStart.getMonth(), 1);
      const endMonth = new Date(regimenEnd.getFullYear(), regimenEnd.getMonth(), 1);

      const rideMap = groupRidesByDate();

      for (let month = new Date(startMonth); month <= endMonth; month.setMonth(month.getMonth() + 1)) {
        const monthContainer = document.createElement("div");
        monthContainer.className = "calendar-month";

        const header = document.createElement("div");
        header.className = "calendar-header";
        const title = document.createElement("h3");
        title.textContent = `${monthNames[month.getMonth()]} ${month.getFullYear()}`;
        header.appendChild(title);
        monthContainer.appendChild(header);

        const grid = document.createElement("div");
        grid.className = "calendar-grid";

        dayNames.forEach((day) => {
          const weekday = document.createElement("div");
          weekday.className = "weekday";
          weekday.textContent = day;
          grid.appendChild(weekday);
        });

        const firstDay = new Date(month.getFullYear(), month.getMonth(), 1).getDay();
        const daysInMonth = new Date(month.getFullYear(), month.getMonth() + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) {
          const emptyCell = document.createElement("div");
          emptyCell.className = "day-cell other-month";
          grid.appendChild(emptyCell);
        }

        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.className = "day-cell";
          cell.textContent = day;

          const cellDate = new Date(month.getFullYear(), month.getMonth(), day);
          const key = formatKey(cellDate);
          const ridesForDay = rideMap.get(key);

          if (ridesForDay && ridesForDay.length) {
            cell.classList.add("has-ride");
            cell.setAttribute("role", "button");
            cell.setAttribute("tabindex", "0");
            cell.addEventListener("click", () => showRideToast(cellDate, ridesForDay));
            cell.addEventListener("keypress", (event) => {
              if (event.key === "Enter" || event.key === " ") {
                event.preventDefault();
                showRideToast(cellDate, ridesForDay);
              }
            });
          }

          grid.appendChild(cell);
        }

        monthContainer.appendChild(grid);
        calendarMonths.appendChild(monthContainer);
      }
    }

    function showRideToast(date, ridesForDay) {
      const formattedDate = formatDate(date);
      const items = ridesForDay
        .map((ride) => {
          const parts = [
            `${formatNumber(ride.distance)} km`,
            `${formatDuration(ride.durationMinutes)}`,
            `Avg ${formatNumber(calculateSpeed(ride))} km/h`
          ];
          if (ride.notes) {
            parts.push(`Notes: ${escapeHTML(ride.notes)}`);
          }
          return `<li>${parts.join(" · ")}</li>`;
        })
        .join("");

      toast.innerHTML = `<h4>${formattedDate}</h4><ul>${items}</ul>`;
      toast.classList.add("visible");

      if (toastTimer) {
        clearTimeout(toastTimer);
      }

      toastTimer = setTimeout(() => {
        toast.classList.remove("visible");
      }, 5000);
    }

    function groupRidesByDate() {
      const map = new Map();
      rides.forEach((ride) => {
        const key = formatKey(ride.date);
        if (!map.has(key)) {
          map.set(key, []);
        }
        map.get(key).push(ride);
      });
      return map;
    }

    function updateStats() {
      const today = new Date();
      const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
      const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0, 23, 59, 59);

      const thisMonthRides = rides.filter((ride) => ride.date >= monthStart && ride.date <= monthEnd);

      applyStats("thisMonth", thisMonthRides);
      applyStats("allTime", rides);
    }

    function applyStats(prefix, rideArray) {
      const totalDistance = rideArray.reduce((sum, ride) => sum + ride.distance, 0);
      const totalMinutes = rideArray.reduce((sum, ride) => sum + ride.durationMinutes, 0);
      const rideCount = rideArray.length;
      const averageDistance = rideCount ? totalDistance / rideCount : 0;
      const averageSpeed = totalMinutes ? (totalDistance / (totalMinutes / 60)) : 0;
      const longestRide = rideCount ? Math.max(...rideArray.map((ride) => ride.distance)) : 0;

      document.getElementById(`${prefix}TotalDistance`).textContent = `${formatNumber(totalDistance)} km`;
      document.getElementById(`${prefix}AverageDistance`).textContent = `${formatNumber(averageDistance)} km`;
      document.getElementById(`${prefix}AverageSpeed`).textContent = `${formatNumber(averageSpeed)} km/h`;
      document.getElementById(`${prefix}LongestRide`).textContent = `${formatNumber(longestRide)} km`;
    }

    function enforceDateBounds() {
      if (!regimenStart || !regimenEnd) {
        return;
      }

      const rideDateInput = document.getElementById("rideDate");
      rideDateInput.min = regimenStart.toISOString().split("T")[0];
      rideDateInput.max = regimenEnd.toISOString().split("T")[0];
    }

    function formatDate(date) {
      const day = String(date.getDate()).padStart(2, "0");
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function formatDuration(totalMinutes) {
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}`;
    }

    function calculateSpeed(ride) {
      if (!ride.durationMinutes) return 0;
      return ride.distance / (ride.durationMinutes / 60);
    }

    function formatNumber(value) {
      if (!Number.isFinite(value) || value === 0) {
        return "0";
      }
      const rounded = Math.round(value * 10) / 10;
      return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
    }

    function clamp(value) {
      return Math.max(0, Math.min(1, value));
    }

    function addMonths(date, months) {
      const result = new Date(date);
      result.setMonth(result.getMonth() + months);
      return result;
    }

    function diffInDays(start, end) {
      const ms = startOfDay(end).getTime() - startOfDay(start).getTime();
      return Math.round(ms / 86400000);
    }

    function startOfDay(date) {
      return new Date(date.getFullYear(), date.getMonth(), date.getDate());
    }

    function formatKey(date) {
      const d = startOfDay(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;
    }

    function escapeHTML(value) {
      const div = document.createElement("div");
      div.textContent = value;
      return div.innerHTML;
    }

    renderPhases();
    renderQuotes();
    renderRideList();
  </script>
</body>
</html>
